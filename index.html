<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E&C | Executive Grid</title>
    <style>
        :root {
            --brand-gold: #cca300;
            --bg-deep: #050505;
            --table-bg: #0f0f12;
            --border: #222;
            --text: #e0e0e0;
            --dim: #777;
            --row-hover: #16161a;
            --pickup-accent: #cc5200;
            --delivery-accent: #00b32d;
            --header-bg: #000;
            --control-bg: #0a0a0c;
            --input-bg: #111;
            --card-bg: #111;
            --details-bg: #0e0e10;
        }

        /* Light Mode Overrides */
        body.light-mode {
            --bg-deep: #e6e8eb;
            --table-bg: #f0f0f0;
            --border: #ccc;
            --text: #000;
            --dim: #555;
            --row-hover: #e4e6eb;
            --pickup-accent: #000;
            --delivery-accent: #000;
            --header-bg: #e0e0e0;
            --control-bg: #f0f0f0;
            --input-bg: #f0f0f0;
            --card-bg: #f0f0f0;
            --details-bg: #ebebeb;
        }

        body.light-mode * { color: #000 !important; border-color: #ccc !important; }
        body.light-mode .type-tag { border: 1px solid #000 !important; }
        body.light-mode th { background: #e0e0e0 !important; }
        body.light-mode .print-btn { background: #e0e0e0 !important; }
        body.light-mode .login-box { background: #f0f0f0 !important; }
        body.light-mode .login-input { background: #f0f0f0 !important; }

        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-deep);
            color: var(--text);
            margin: 0;
            overflow: hidden; /* We will use internal scrolling for the grid */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- AUTH OVERLAY --- */
        #login-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box {
            width: 350px; background: #111; padding: 40px; border-radius: 8px; 
            border: 1px solid var(--border); text-align: center;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 10px 0; background: #000; 
            border: 1px solid #333; color: #fff; border-radius: 4px;
        }
        .login-submit {
            width: 100%; padding: 12px; background: var(--brand-gold); border: none; 
            color: #000; font-weight: 800; cursor: pointer; border-radius: 4px; margin-top: 10px;
        }

        /* --- HEADER --- */
        header {
            padding: 10px 20px;
            background: var(--header-bg);
            border-bottom: 2px solid var(--brand-gold);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            flex-shrink: 0;
            position: relative;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .header-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-top: 10px;
        }

        .logo-group { display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .logo {
            height: 40px;
            filter: drop-shadow(0 0 5px rgba(204, 163, 0, 0.3));
            animation: ultraSlowShine 10s infinite ease-in-out;
        }
        @keyframes ultraSlowShine {
            0%, 100% { filter: drop-shadow(0 0 2px var(--brand-gold)); opacity: 0.8; }
            50% { filter: drop-shadow(0 0 12px var(--brand-gold)); opacity: 1; }
        }
        .brand-title { font-weight: 900; letter-spacing: 2px; text-transform: uppercase; color: #fff; font-size: 1.1rem; }

        /* --- CONTROL BAR --- */
        .controls {
            padding: 15px 20px;
            background: var(--control-bg);
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-bottom: 1px solid var(--border);
        }

        .filter-input {
            background: var(--input-bg); border: 1px solid var(--border); color: var(--text);
            padding: 8px 12px; border-radius: 4px; font-size: 0.9rem;
        }
        .filter-input:focus { border-color: var(--brand-gold); outline: none; }

        .range-btn {
            background: var(--input-bg); border: 1px solid var(--border); color: var(--dim);
            padding: 8px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; cursor: pointer;
            transition: 0.2s;
        }
        .range-btn:hover, .range-btn.active { border-color: var(--brand-gold); color: var(--text); background: #222; }
        body.light-mode .range-btn:hover, body.light-mode .range-btn.active { background: #e0e0e0 !important; }

        .print-btn {
            background: #222; border: 1px solid var(--brand-gold); color: var(--brand-gold);
            padding: 8px 15px; border-radius: 4px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.8rem;
        }
        .print-btn:hover { background: var(--brand-gold); color: #000; }

        /* --- DATA GRID --- */
        .grid-container {
            flex: 1;
            overflow: auto;
            background: var(--bg-deep);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 1200px;
        }

        thead {
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
        }

        th {
            text-align: left;
            padding: 8px 10px;
            color: var(--dim);
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--brand-gold);
            white-space: nowrap;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tbody tr.summary-row { cursor: pointer; transition: 0.2s; }
        tbody tr.summary-row:hover { background: var(--row-hover); }

        .details-row { display: none; background: var(--control-bg); }
        .details-row.open { display: table-row; }
        .details-content { padding: 20px; display: flex; gap: 40px; flex-wrap: wrap; border-bottom: 2px solid var(--border); }
        
        .detail-group { display: flex; flex-direction: column; gap: 5px; }
        .detail-label { font-size: 10px; color: var(--dim); font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
        .detail-value { font-size: 14px; color: var(--text); }

        .copy-icon {
            cursor: pointer; color: var(--brand-gold); margin-right: 8px; font-size: 12px;
        }
        .copy-btn-lg {
            background: #222; border: 1px solid #444; color: var(--text); padding: 5px 10px;
            border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 5px;
        }
        .copy-btn-lg:hover { border-color: var(--brand-gold); color: var(--brand-gold); }
        body.light-mode .copy-btn-lg { background: #f0f0f0 !important; }

        .type-tag {
            padding: 3px 8px; border-radius: 3px; font-weight: 900; font-size: 10px;
        }
        .date-cell { white-space: nowrap; font-family: monospace; color: var(--dim); }
        .driver-cell { font-weight: 800; color: var(--brand-gold); }

        /* --- VISIBILITY TOGGLES --- */
        .col-toggle-group { display: flex; gap: 15px; width: 100%; margin-top: 10px; }
        .col-checkbox { display: flex; align-items: center; gap: 3px; font-size: 14px; color: var(--dim); font-weight: 700; cursor: pointer; }
        .col-checkbox input { accent-color: var(--brand-gold); cursor: pointer; }
        .hide-col { display: none !important; }

        /* Desktop Utilities for Type Group */
        .type-wrap { display: flex; gap: 5px; align-items: center; }
        .range-scroll { display: flex; gap: 8px; flex-wrap: wrap; }
        .mobile-hint { display: none; }
        .mobile-copy { display: none; }
        .card-date, .card-time { display: none; }

        /* --- PRINT STYLES --- */
        @media print {
            @page { size: landscape; margin: 0.5cm; }
            body { height: auto; overflow: visible; background: #fff; color: #000; }
            .grid-container { overflow: visible; height: auto; }
            .controls, header, #login-overlay, .copy-icon, .copy-btn-lg, #mobile-blocker { display: none !important; }
            
            table { width: 100%; border-collapse: collapse; min-width: 0; font-size: 8px; }
            th { background: #fff; color: #000; border-bottom: 2px solid #000; position: static; }
            td { color: #000; border-bottom: 1px solid #ccc; }
            
            /* Force all details to show */
            .details-row { display: table-row !important; }
            .details-content { display: flex !important; gap: 20px; border-bottom: 1px solid #000; padding: 10px; }
            .detail-label { color: #444; }
            .detail-value { color: #000; font-weight: 600; }
            
            /* Force all columns to be visible when printing regardless of checkbox state */
            .hide-col { display: table-cell !important; }
            
            /* Adjust badges */
            .type-tag { border: 1px solid #000; }
        }

        /* --- MOBILE CARD VIEW --- */
        @media (max-width: 768px) {
            body { height: auto; overflow-y: auto; }
            .grid-container { overflow: visible; height: auto; padding-bottom: 40px; }

            /* Hide Desktop Elements: Table Header, Print/Export Buttons, Column Toggles */
            thead, .print-btn, .col-toggle-group, .copy-icon, #columnToggles { display: none !important; }

            /* Header Adjustments */
            header { height: auto; gap: 10px; align-items: stretch; padding: 15px; }
            .header-top { justify-content: space-between; }
            .header-bottom { flex-direction: row; justify-content: space-between; margin-top: 5px; }
            #live-stat { text-align: right !important; font-size: 12px; }

            /* Control Bar Adjustments */
            .controls { height: auto; flex-direction: column; align-items: stretch; gap: 12px; padding: 15px; }
            .controls-top { display: flex; flex-direction: column; align-items: stretch; gap: 12px; }
            .controls-bottom { display: flex; flex-direction: column; align-items: stretch; gap: 12px; margin-top: 0; }
            .controls-top > div, .controls-bottom > div { width: 100%; }
            .filter-input, select.filter-input { width: 100% !important; font-size: 16px; padding: 12px; } /* 16px prevents iOS zoom */
            
            /* Mobile Filter Layout */
            .type-wrap { flex-direction: row; align-items: center; gap: 10px; }
            .range-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; width: 100%; flex-wrap: nowrap; }
            .mobile-hint { 
                display: block; position: absolute; right: 0; top: auto; bottom: -8px; 
                color: var(--brand-gold); font-size: 22px; animation: bounce 1s infinite;
            }
            @keyframes bounce { 0%,100%{transform:translateX(0);} 50%{transform:translateX(3px);} }

            /* Scrollable Range Buttons */
            .range-btn { flex-shrink: 0; padding: 10px 16px; font-size: 14px; }
            
            /* Full Width Reset Button */
            button[onclick="clearFilters()"] { width: 100%; padding: 12px; margin-top: 5px; background: #222; border: 1px solid #444; }

            /* Card Layout */
            table { display: block; width: 100%; min-width: 0; }
            tbody { display: block; width: 100%; }

            tr.summary-row {
                display: flex;
                flex-direction: column;
                background: var(--card-bg);
                border: 1px solid var(--border);
                margin: 0 10px 10px 10px; /* Spacing between cards */
                border-radius: 6px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                position: relative; /* For absolutely positioning the date */
                padding-top: 30px; /* Make room for the date */
            }

            .card-date {
                display: block;
                position: absolute;
                top: 8px;
                left: 12px;
                font-size: 12px;
                font-weight: 800;
                color: var(--brand-gold);
                letter-spacing: 1px;
            }

            .card-time {
                display: block;
                position: absolute;
                top: 8px;
                right: 12px;
                font-size: 12px;
                font-weight: 800;
                color: var(--brand-gold);
                letter-spacing: 1px;
            }

            td {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                text-align: right;
                border-bottom: 1px solid var(--border);
                padding: 8px 12px;
                font-size: 14px; /* Optimized legibility */
                height: auto;
            }
            td:last-child { border-bottom: none; }
            
            /* Force visibility of all data columns regardless of desktop toggle state */
            .hide-col { display: flex !important; }

            /* Labels via CSS generated content */
            .col-0::before { content: "Date"; }
            .col-1::before { content: "Pickup Contact"; }
            .col-2::before { content: "Pickup Address"; }
            .col-3::before { content: "Pickup City"; }
            .col-4::before { content: "Delivery Contact"; }
            .col-5::before { content: "Delivery Address"; }
            .col-6::before { content: "Delivery City"; }
            .col-7::before { content: "Packages"; }

            td::before {
                color: var(--dim);
                font-weight: 800;
                font-size: 11px;
                text-transform: uppercase;
                margin-right: 15px;
                min-width: 80px;
                text-align: left;
                padding-top: 2px;
            }

            /* Details Panel Expansion */
            .details-row { display: none; }
            .details-row.open { display: block; }
            
            .details-row td {
                display: block;
                padding: 0;
                border: none;
            }

            .details-content {
                display: flex;
                flex-direction: column;
                gap: 20px;
                padding: 20px;
                background: var(--details-bg);
                margin: -16px 15px 25px 15px; /* Pull up to attach to card, push down next card */
                border-radius: 0 0 8px 8px;
                border: 1px solid var(--border);
                border-top: 1px solid var(--border);
            }
            
            .detail-value { font-size: 16px; line-height: 1.4; word-break: break-word; }
            .copy-btn-lg { padding: 12px; width: 100%; font-size: 14px; margin-top: 10px; }

            /* Copy Icon */
            .mobile-copy { display: inline-block; margin-left: 10px; cursor: pointer; color: var(--brand-gold); }
            .col-0 { align-items: center; } 
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color: var(--brand-gold); margin-bottom: 20px;">EXECUTIVE GRID</h2>
        <input type="email" id="login-user" class="login-input" placeholder="Admin Email" autofocus>
        <input type="password" id="login-pin" class="login-input" placeholder="Password">
        <button class="login-submit" onclick="attemptLogin()">Authorize</button>
    </div>
</div>

<header>
    <div class="header-top">
        <div class="logo-group" onclick="toggleTheme()">
            <img src="icon-512.png" class="logo" alt="Logo">
            <span class="brand-title">E&C | Executive Data Hub</span>
        </div>
        <button onclick="manualBackup()" class="print-btn" style="background-color: #0077be; color: #fff; border-color: #0077be;">BACK UP NOW</button>
    </div>
    <div class="header-bottom">
        <div id="user-info" style="color: #00ff00; font-size: 12px; font-weight: 800; text-transform: uppercase;">SIGNED IN AS: <span id="current-user-display"></span></div>
        <div id="live-stat" style="font-size: 0.8rem; font-weight: 800; color: var(--dim); text-align: right;">
            <span id="counter" style="color: var(--brand-gold);">0</span> ENTRIES FOUND
        </div>
    </div>
</header>

<div class="controls">
    <div class="controls-top" style="display: flex; gap: 15px; align-items: flex-end; width: 100%; flex-wrap: wrap;">
        <div style="display:flex; flex-direction:column; gap:4px;">
            <label style="font-size: 10px; font-weight: 800; color: var(--dim);">GLOBAL SEARCH</label>
            <form action="javascript:void(0);" style="margin: 0;">
                <input type="text" id="globalSearch" class="filter-input" style="width: 250px;" placeholder="Filter everything...">
            </form>
        </div>
        
        <div style="display:flex; flex-direction:column; gap:4px;">
            <label style="font-size: 10px; font-weight: 800; color: var(--dim);">DATE FROM</label>
            <input type="date" id="dateFrom" class="filter-input">
        </div>

        <div style="display:flex; flex-direction:column; gap:4px;">
            <label style="font-size: 10px; font-weight: 800; color: var(--dim);">DATE TO</label>
            <input type="date" id="dateTo" class="filter-input">
        </div>

        <button onclick="clearFilters()" style="margin-bottom: 2px; background: transparent; border: 1px solid #444; color: var(--text); padding: 7px 15px; cursor: pointer; border-radius: 4px; font-size: 12px;">RESET</button>
        
        <div style="margin-left: auto; display: flex; gap: 10px; margin-bottom: 2px;">
            <button onclick="exportCurrentView()" class="print-btn" style="border-color: #555; color: var(--text);">EXPORT CSV</button>
        </div>
    </div>

    <div class="controls-bottom" style="display: flex; gap: 15px; align-items: center; width: 100%; flex-wrap: wrap; margin-top: 5px;">
        <div style="display:flex; align-items: center; gap: 10px; position: relative;">
            <label style="font-size: 10px; font-weight: 800; color: var(--dim);">DATE RANGE</label>
            <span class="mobile-hint">&rarr;</span>
        </div>
        <div class="range-scroll">
            <button class="range-btn" onclick="updateRange(1)">Yesterday</button>
            <button class="range-btn" onclick="updateRange(3)">Last 3 Days</button>
            <button class="range-btn" onclick="updateRange(7)">Last 7 Days</button>
            <button class="range-btn" onclick="updateRange(14)">Last 14 Days</button>
            <button class="range-btn" onclick="updateRange(30)">Last 30 Days</button>
            <button class="range-btn" onclick="updateRange(90)">Last 3 Months</button>
            <button class="range-btn" onclick="updateRange(180)">Last 6 Months</button>
            <button class="range-btn" onclick="updateRange('all')">All Time</button>
        </div>
        <div id="columnToggles" class="col-toggle-group" style="margin-top: 0; margin-left: 0; width: auto; align-items: center;"></div>
    </div>
</div>

<div class="grid-container">
    <table id="dataTable">
        <thead>
            <tr>
                <th class="col-0">Date</th>
                <th class="col-1">Pickup Contact</th>
                <th class="col-2">Pickup Address</th>
                <th class="col-3">Pickup City</th>
                <th class="col-4">Delivery Contact</th>
                <th class="col-5">Delivery Address</th>
                <th class="col-6">Delivery City</th>
                <th class="col-7">Packages</th>
            </tr>
        </thead>
        <tbody id="gridBody">
            </tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    firebase.initializeApp({
        apiKey: "AIzaSyAKmgoXA4m3cRTmxJq4aUyva5SVvFbTNqg",
        authDomain: "eandccourier-36fcc.firebaseapp.com",
        databaseURL: "https://eandccourier-36fcc-default-rtdb.firebaseio.com",
        projectId: "eandccourier-36fcc"
    });
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION);

    const db = firebase.database();
    let masterData = [];
    let filteredData = []; // Store currently visible data
    let currentRange = 7; // Default 7 days
    const listeners = { jobs: null };

    // Column Config
    const columnConfig = [
        "Date", "Pickup Contact", "Pickup Address", "Pickup City", "Delivery Contact", "Delivery Address", "Delivery City", "Packages"
    ];
    let visibleCols = new Array(8).fill(true);

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", () => {
        renderColumnToggles();
        if (localStorage.getItem('ec_grid_theme') === 'light') {
            document.body.classList.add('light-mode');
        }
        
        // Hide keyboard on enter for search
        document.getElementById('globalSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.blur();
                applyFilters();
            }
        });
    });

    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('ec_grid_theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    }

    function renderColumnToggles() {
        const container = document.getElementById('columnToggles');
        container.innerHTML = "";
        columnConfig.forEach((col, idx) => {
            const label = document.createElement('label');
            label.className = "col-checkbox";
            label.innerHTML = `<input type="checkbox" checked onchange="toggleColumn(${idx}, this.checked)"> ${col.toUpperCase()}`;
            container.appendChild(label);
        });
    }

    function toggleColumn(idx, isVisible) {
        visibleCols[idx] = isVisible;
        const styleId = `style-col-${idx}`;
        let styleTag = document.getElementById(styleId);
        
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = styleId;
            document.head.appendChild(styleTag);
        }

        // Toggle visibility using CSS class injection
        if (!isVisible) {
            styleTag.innerHTML = `.col-${idx} { display: none; }`;
        } else {
            styleTag.innerHTML = "";
        }
    }

    // --- ACCESS CONTROL ---
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            const username = user.email.split('@')[0].toLowerCase();
            db.ref(`roles/${username}/grid`).once('value').then(snapshot => {
                if (snapshot.val() === true) {
                    currentDriver = username;
                    document.getElementById('login-overlay').style.display = 'none';
                    document.querySelector('header').style.display = 'flex';
                    clearAllNotifications();
                    startContinuousTracking();
                    setupIntersectionObserver();
                    startDataListeners();
                    mergeAndRender();
                } else {
                    alert("ACCESS DENIED");
                    firebase.auth().signOut();
                    document.getElementById('login-overlay').style.display = 'flex';
                }
            });
        }
    });

    function attemptLogin() {
        const email = document.getElementById('login-user').value.trim();
        const pin = document.getElementById('login-pin').value.trim();
        firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
            .then(() => firebase.auth().signInWithEmailAndPassword(email, pin))
            .catch(e => alert(e.message));
    }

    // --- DATA FLOW ---
    function updateRange(days) {
        currentRange = days;
        initSync(days);
    }

    function initSync(days) {
        // Detach old listeners if they exist
        if (listeners.jobs) db.ref('jobs').off('value', listeners.jobs);

        masterData = []; // Clear current data
        document.getElementById('gridBody').innerHTML = ""; 

        let queryJobs = db.ref('jobs').orderByChild('timestamp');

        if (days !== 'all') {
            let startTime;
            const now = new Date();
            if (days === 1) {
                // Yesterday: from start of yesterday to end of yesterday
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(0,0,0,0);
                startTime = yesterday.getTime();
                // To get ONLY yesterday, we could use endAt, but for simplicity of stream, we fetch from start and filter in stream
            } else if (days === 3) {
                // Last 3 days including today
                const threeDaysAgo = new Date(now);
                threeDaysAgo.setDate(threeDaysAgo.getDate() - 2); // 2 days ago + today = 3 days
                threeDaysAgo.setHours(0,0,0,0);
                startTime = threeDaysAgo.getTime();
            } else {
                const ms = days * 24 * 60 * 60 * 1000;
                startTime = Date.now() - ms;
            }
            queryJobs = queryJobs.startAt(startTime);
        }

        listeners.jobs = queryJobs.on('value', s => stream(s.val(), days));
    }

    function stream(data, daysFilter) {
        let rawData = Object.entries(data || {}).map(([id, val]) => ({ ...val, id }));
        
        if (daysFilter === 1) {
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            rawData = rawData.filter(item => item.timestamp < startOfToday);
        }

        masterData = rawData;
        masterData.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
        applyFilters();
    }

    // --- BACKUP & EXPORT SYSTEM ---
    
    function generateFileContent(dataArray, title) {
        if (dataArray.length === 0) return "No Data Found.";
        
        let csv = `ID,Date,Status,Driver,Pickup,Delivery,Pickup Addr,Deliv Addr,City,PO,Details,Notes,Created By,Last Edit By\n`;
        
        dataArray.forEach(item => {
            let row = [
                item.id || '',
                new Date(item.timestamp).toLocaleString(),
                (item.status || 'unknown').toUpperCase(),
                item.assigned_to || '',
                item.name || 'N/A',
                item.delivery_name || 'N/A',
                item.pickup_location || 'N/A',
                item.destination || 'N/A',
                item.city || '',
                item.po_number || '',
                item.package_details || '',
                item.other_info || '',
                item.created_by || '?',
                item.last_edit_by || '?'
            ];
            csv += row.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',') + "\n";
        });
        return csv;
    }

    function downloadTextFile(filename, content) {
        const blob = new Blob(["\uFEFF" + content], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
    }

    function getBackupFilename(startMs, endMs) {
        const months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
        const s = new Date(startMs);
        const e = new Date(endMs);
        return `backup_${months[s.getMonth()]}${s.getDate()}_${months[e.getMonth()]}${e.getDate()}.csv`;
    }

    function checkAutoBackup() {
        const lastBackup = localStorage.getItem('ec_last_backup');
        const now = new Date();
        const isFriday = now.getDay() === 5; // 5 is Friday
        
        const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
        const timeSince = lastBackup ? now - new Date(lastBackup) : Infinity;

        if (isFriday && timeSince > (sevenDaysMs - 86400000)) { 
            backupLast7Days(true);
        }
    }

    function backupLast7Days(isAuto = false) {
        const now = Date.now();
        const sevenDaysAgo = now - (7 * 24 * 60 * 60 * 1000);
        
        // We need to fetch/filter from masterData based on strict timestamp
        const backupData = masterData.filter(item => {
            return item.timestamp >= sevenDaysAgo && item.timestamp <= now;
        });

        const filename = getBackupFilename(sevenDaysAgo, now);
        const content = generateFileContent(backupData, "E&C EXECUTIVE DATA BACKUP (7 DAYS)");
        
        downloadTextFile(filename, content);

        if (isAuto) {
            localStorage.setItem('ec_last_backup', new Date().toISOString());
        }
    }

    function manualBackup() {
        backupLast7Days(false);
    }

    function exportCurrentView() {
        const content = generateFileContent(filteredData, "E&C EXPORT - CURRENT VIEW");
        downloadTextFile(`EC_Export_${new Date().toISOString().split('T')[0]}.csv`, content);
    }

    function printAndDownload() {
        window.print();
    }

    // --- UI HELPERS ---
    function copyLine(btn, dataStr) {
        navigator.clipboard.writeText(dataStr).then(() => {
            const span = document.createElement('span');
            span.innerText = " Copied!";
            span.style.color = "var(--brand-gold)";
            span.style.fontSize = "10px";
            span.style.fontWeight = "bold";
            btn.parentNode.insertBefore(span, btn.nextSibling);
            setTimeout(() => span.remove(), 1500);
        });
        event.stopPropagation();
    }

    function copyCardAll(btn, itemStr) {
        const item = JSON.parse(decodeURIComponent(itemStr));
        const text = `Date: ${new Date(item.timestamp).toLocaleString()}\nStatus: ${item.status || 'N/A'}\nDriver: ${item.assigned_to}\nPickup: ${item.name}\nDelivery: ${item.delivery_name}\nPickup Addr: ${item.pickup_location || 'N/A'}\nDeliv Addr: ${item.destination || 'N/A'}\nCity: ${item.city}\nPO: ${item.po_number}\nDetails: ${item.package_details}\nNotes: ${item.other_info}`;
        
        navigator.clipboard.writeText(text).then(() => {
            const original = btn.innerText;
            btn.innerText = "COPIED TO CLIPBOARD";
            setTimeout(() => btn.innerText = original, 1500);
        });
    }

    function toggleDetails(rowId) {
        const detailRow = document.getElementById('detail-' + rowId);
        if (detailRow.style.display === 'table-row' || detailRow.style.display === 'block') {
            detailRow.style.display = 'none';
        } else {
            // Check if mobile via matchMedia, otherwise standard table-row
            if (window.matchMedia("(max-width: 768px)").matches) {
                detailRow.style.display = 'block';
            } else {
                detailRow.style.display = 'table-row';
            }
        }
    }

    function clearFilters() {
        document.getElementById('globalSearch').value = "";
        document.getElementById('dateFrom').value = "";
        document.getElementById('dateTo').value = "";
        applyFilters();
    }

    function formatTime12(ts) { 
        if (!ts) return ''; 
        const d = new Date(ts); 
        return isNaN(d.getTime()) ? '' : d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }); 
    }

    function applyFilters() {
        const search = document.getElementById('globalSearch').value.toLowerCase();
        const fromDateStr = document.getElementById('dateFrom').value;
        const toDateStr = document.getElementById('dateTo').value;
        const body = document.getElementById('gridBody');
        
        body.innerHTML = "";
        
        let fromTime = null;
        let toTime = null;

        if (fromDateStr) {
            const [y, m, d] = fromDateStr.split('-');
            fromTime = new Date(y, m - 1, d, 0, 0, 0).getTime();
        }
        if (toDateStr) {
            const [y, m, d] = toDateStr.split('-');
            toTime = new Date(y, m - 1, d, 23, 59, 59, 999).getTime();
        } else if (fromDateStr) {
            // If fromDate is set but toDate is not, toDate becomes end of fromDate
            const [y, m, d] = fromDateStr.split('-');
            toTime = new Date(y, m - 1, d, 23, 59, 59, 999).getTime();
        }
        
        filteredData = masterData.filter(item => {
            const ts = item.timestamp || 0;
            
            const matchSearch = JSON.stringify(item).toLowerCase().includes(search);
            const matchFrom = !fromTime || ts >= fromTime;
            const matchTo = !toTime || ts <= toTime;
            
            return matchSearch && matchFrom && matchTo;
        });

        document.getElementById('counter').innerText = filteredData.length;

        filteredData.forEach(item => {
            const pickupName = item.name || 'N/A';
            const delivName = item.delivery_name || 'N/A';
            
            const itemDateObj = new Date(item.timestamp);
            const formattedDateStr = itemDateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            const completedTimeStr = formatTime12(item.completed_at);

            const tr = document.createElement('tr');
            tr.className = "summary-row";
            tr.onclick = () => toggleDetails(item.id);
            
            // Added card-date and card-time inside the first td to fix desktop table layout while preserving mobile
            tr.innerHTML = `
                <td class="col-0">${formattedDateStr}</td>
                <td class="col-1" style="font-weight:700; color:var(--pickup-accent);">
                    <div class="card-date">${formattedDateStr}</div>
                    ${completedTimeStr ? `<div class="card-time">${completedTimeStr}</div>` : ''}
                    ${pickupName}
                </td>
                <td class="col-2">${item.pickup_location || ''}</td>
                <td class="col-3">${item.pickup_city || item.city || ''}</td>
                <td class="col-4" style="font-weight:700; color:var(--delivery-accent);">${delivName}</td>
                <td class="col-5">${item.destination || ''}</td>
                <td class="col-6">${item.delivery_city || item.city || ''}</td>
                <td class="col-7" style="font-weight:700; color:var(--brand-gold);">${item.package_details || ''}</td>
            `;
            
            const detailTr = document.createElement('tr');
            detailTr.id = 'detail-' + item.id;
            detailTr.className = 'details-row';
            detailTr.innerHTML = `
                <td colspan="8">
                    <div class="details-content">
                        <div class="detail-group">
                            <span class="detail-label">DRIVER</span>
                            <span class="detail-value" style="font-weight:800; color:var(--brand-gold);">${(item.assigned_to || '---').toUpperCase()}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">PO / REFERENCE</span>
                            <span class="detail-value" style="color:var(--brand-gold);">${item.po_number || 'N/A'}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">STATUS</span>
                            <span class="detail-value" style="font-weight:900; color:${item.status === 'completed' ? 'var(--delivery-accent)' : 'var(--pickup-accent)'}">${(item.status || 'pending').toUpperCase()}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">DRIVER NOTES (OTHER INFO)</span>
                            <span class="detail-value" style="font-style:italic; color:#aaa;">${item.other_info || 'None'}</span>
                        </div>
                         <div class="detail-group">
                            <span class="detail-label">CREATED BY</span>
                            <span class="detail-value">${item.created_by || 'Unknown'}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">LAST EDIT BY</span>
                            <span class="detail-value">${item.last_edit_by || 'Unknown'}</span>
                        </div>
                        <div class="detail-group" style="margin-left:auto; text-align:right;">
                             <span class="detail-label" style="display:block; margin-bottom: 5px;">DATE</span>
                             <span class="detail-value" style="display:block; margin-bottom: 15px;">
                                <div style="display:flex; align-items:center; justify-content: flex-end;">${formattedDateStr}<span class="mobile-copy" onclick="copyLine(this, '${formattedDateStr}')">❐</span></div>
                             </span>
                            <button class="copy-btn-lg" onclick="copyCardAll(this, '${encodeURIComponent(JSON.stringify(item))}')">COPY CARD INFO</button>
                        </div>
                    </div>
                </td>
            `;

            body.appendChild(tr);
            body.appendChild(detailTr);
        });
    }

    document.querySelectorAll('.filter-input').forEach(el => el.addEventListener('input', applyFilters));
</script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<style>
  #dev-btn { position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: #ffd700; color: #000; border: none; padding: 12px 18px; border-radius: 6px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); font-size: 12px; text-transform: uppercase; }
  #dev-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; }
  #dev-box { background: #1a1a1a; width: 95%; max-width: 600px; height: 80vh; border-radius: 8px; border: 1px solid #ffd700; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; font-family: sans-serif; }
  #dev-list { flex: 1; overflow-y: auto; background: #111; padding: 15px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #333; color: #fff; font-size: 14px; }
  .dev-item { border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
  .dev-hdr { font-size: 11px; color: #ffd700; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
  #dev-editor { background: #fff; color: #000; height: 120px; }
  .dev-row { display: flex; gap: 10px; margin-top: 10px; }
  .dev-action { flex: 1; padding: 12px; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; text-transform: uppercase; font-size: 12px; }
  .ql-toolbar { background: #eee; }
</style>

<button id="dev-btn" onclick="document.getElementById('dev-modal').style.display='flex'">Dev Notes</button>

<div id="dev-modal">
  <div id="dev-box">
    <h3 style="margin:0 0 10px 0; color:#ffd700; text-transform:uppercase;">Developer Notes</h3>
    <div id="dev-list"></div>
    <div id="dev-editor"></div>
    <div class="dev-row">
      <button class="dev-action" style="background:#333; color:#fff;" onclick="document.getElementById('dev-modal').style.display='none'">Close</button>
      <button class="dev-action" style="background:#00b32d; color:#000;" onclick="saveDevNote()">Save Note</button>
    </div>
  </div>
</div>

<script>
  let devQuill;
  
  // Wait for the app's main Firebase script to load first
  setTimeout(() => {
    devQuill = new Quill('#dev-editor', {
      theme: 'snow',
      modules: { toolbar: [ ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'align': [] }] ] }
    });

    // Load notes from Firebase
    firebase.database().ref('developer').on('value', snap => {
      const list = document.getElementById('dev-list');
      list.innerHTML = '';
      const notes = snap.val() || {};
      Object.values(notes).forEach(note => {
        list.innerHTML += `<div class="dev-item"><div class="dev-hdr">${note.user} • ${note.date}</div><div>${note.text}</div></div>`;
      });
      list.scrollTop = list.scrollHeight; // Auto-scroll to bottom
    });
  }, 1000); 

  function saveDevNote() {
    if (devQuill.getText().trim() === "") return;
    
    // Get user or fallback to Unknown
    let user = "Unknown User";
    if (firebase.auth().currentUser) {
      user = firebase.auth().currentUser.email.split('@')[0];
    }
    
    // Get formatted date and time
    const now = new Date();
    const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    // Save to database
    firebase.database().ref('developer').push({
      text: devQuill.root.innerHTML,
      user: user,
      date: dateStr,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    devQuill.setText(''); // Clear typing area
  }
</script>
</body>
</html>
