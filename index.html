<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E&C | Executive Grid</title>
    <style>
        :root {
            --brand-gold: #cca300;
            --bg-deep: #050505;
            --table-bg: #0f0f12;
            --border: #222;
            --text: #e0e0e0;
            --dim: #777;
            --row-hover: #16161a;
            --pickup-accent: #cc5200;
            --delivery-accent: #00b32d;
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-deep);
            color: var(--text);
            margin: 0;
            overflow: hidden; /* We will use internal scrolling for the grid */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- AUTH OVERLAY --- */
        #login-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box {
            width: 350px; background: #111; padding: 40px; border-radius: 8px; 
            border: 1px solid var(--border); text-align: center;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 10px 0; background: #000; 
            border: 1px solid #333; color: #fff; border-radius: 4px;
        }
        .login-submit {
            width: 100%; padding: 12px; background: var(--brand-gold); border: none; 
            color: #000; font-weight: 800; cursor: pointer; border-radius: 4px; margin-top: 10px;
        }

        /* --- HEADER --- */
        header {
            padding: 10px 20px;
            background: #000;
            border-bottom: 2px solid var(--brand-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .logo-group { display: flex; align-items: center; gap: 15px; }
        .logo {
            height: 40px;
            filter: drop-shadow(0 0 5px rgba(204, 163, 0, 0.3));
            animation: ultraSlowShine 10s infinite ease-in-out;
        }
        @keyframes ultraSlowShine {
            0%, 100% { filter: drop-shadow(0 0 2px var(--brand-gold)); opacity: 0.8; }
            50% { filter: drop-shadow(0 0 12px var(--brand-gold)); opacity: 1; }
        }
        .brand-title { font-weight: 900; letter-spacing: 2px; text-transform: uppercase; color: #fff; font-size: 1.1rem; }

        /* --- CONTROL BAR --- */
        .controls {
            padding: 15px 20px;
            background: #0a0a0c;
            display: flex;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .filter-input {
            background: #111; border: 1px solid #333; color: #fff;
            padding: 8px 12px; border-radius: 4px; font-size: 0.9rem;
        }
        .filter-input:focus { border-color: var(--brand-gold); outline: none; }

        /* --- DATA GRID --- */
        .grid-container {
            flex: 1;
            overflow: auto;
            background: var(--bg-deep);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 1200px;
        }

        thead {
            position: sticky;
            top: 0;
            background: #1a1a1d;
            z-index: 10;
        }

        th {
            text-align: left;
            padding: 12px 15px;
            color: var(--dim);
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--brand-gold);
            white-space: nowrap;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:hover { background: var(--row-hover); }

        .copy-btn {
            background: transparent; border: 1px solid #444; color: var(--brand-gold);
            padding: 2px 6px; font-size: 10px; cursor: pointer; border-radius: 3px;
            margin-left: 5px; opacity: 0.6; transition: 0.2s;
        }
        .copy-btn:hover { opacity: 1; background: var(--brand-gold); color: #000; }

        .type-tag {
            padding: 3px 8px; border-radius: 3px; font-weight: 900; font-size: 10px;
        }

        .notes-cell {
            max-width: 250px;
            font-style: italic;
            color: #aaa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        .notes-cell:hover { white-space: normal; overflow: visible; background: #222; position: relative; z-index: 5; }

        .date-cell { white-space: nowrap; font-family: monospace; color: var(--dim); }
        .driver-cell { font-weight: 800; color: var(--brand-gold); }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color: var(--brand-gold); margin-bottom: 20px;">EXECUTIVE GRID</h2>
        <input type="email" id="login-user" class="login-input" placeholder="Admin Email" autofocus>
        <input type="password" id="login-pin" class="login-input" placeholder="Password">
        <button class="login-submit" onclick="attemptLogin()">Authorize</button>
    </div>
</div>

<header>
    <div class="logo-group">
        <img src="icon-512.png" class="logo" alt="Logo">
        <span class="brand-title">E&C | Executive Data Hub</span>
    </div>
    <div id="live-stat" style="font-size: 0.8rem; font-weight: 800; color: var(--dim);">
        <span id="counter" style="color: var(--brand-gold);">0</span> ENTRIES FOUND
    </div>
</header>

<div class="controls">
    <div style="display:flex; flex-direction:column; gap:4px;">
        <label style="font-size: 10px; font-weight: 800; color: var(--dim);">GLOBAL SEARCH</label>
        <input type="text" id="globalSearch" class="filter-input" style="width: 250px;" placeholder="Filter everything...">
    </div>
    
    <div style="display:flex; flex-direction:column; gap:4px;">
        <label style="font-size: 10px; font-weight: 800; color: var(--dim);">DATE FROM</label>
        <input type="date" id="dateFrom" class="filter-input">
    </div>

    <div style="display:flex; flex-direction:column; gap:4px;">
        <label style="font-size: 10px; font-weight: 800; color: var(--dim);">DATE TO</label>
        <input type="date" id="dateTo" class="filter-input">
    </div>

    <div style="display:flex; flex-direction:column; gap:4px;">
        <label style="font-size: 10px; font-weight: 800; color: var(--dim);">TYPE</label>
        <select id="typeFilter" class="filter-input">
            <option value="all">ALL SERVICES</option>
            <option value="pickup">PICKUPS</option>
            <option value="delivery">DELIVERIES</option>
        </select>
    </div>

    <button onclick="clearFilters()" style="margin-top: 18px; background: transparent; border: 1px solid #444; color: #fff; padding: 7px 15px; cursor: pointer; border-radius: 4px; font-size: 12px;">RESET</button>
</div>

<div class="grid-container">
    <table id="dataTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Driver</th>
                <th>Client / Business</th>
                <th>Address</th>
                <th>City</th>
                <th>PO / Ref</th>
                <th>Packages</th>
                <th>Status</th>
                <th>Admin Notes</th>
            </tr>
        </thead>
        <tbody id="gridBody">
            </tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    firebase.initializeApp({
        apiKey: "AIzaSyAKmgoXA4m3cRTmxJq4aUyva5SVvFbTNqg",
        authDomain: "eandccourier-36fcc.firebaseapp.com",
        databaseURL: "https://eandccourier-36fcc-default-rtdb.firebaseio.com",
        projectId: "eandccourier-36fcc"
    });

    const db = firebase.database();
    let masterData = [];

    // --- ACCESS CONTROL ---
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            const admins = ["celeste@ec.com", "desirae@ec.com"];
            if (admins.includes(user.email.toLowerCase())) {
                document.getElementById('login-overlay').style.display = 'none';
                initSync();
            } else {
                alert("Restricted Access.");
                firebase.auth().signOut();
            }
        }
    });

    function attemptLogin() {
        const email = document.getElementById('login-user').value.trim();
        const pin = document.getElementById('login-pin').value.trim();
        firebase.auth().signInWithEmailAndPassword(email, pin).catch(e => alert(e.message));
    }

    // --- DATA FLOW ---
    function initSync() {
        db.ref('pickups').on('value', s => stream('pickup', s.val()));
        db.ref('dropoffs').on('value', s => stream('delivery', s.val()));
    }

    function stream(type, data) {
        const processed = Object.entries(data || {}).map(([id, val]) => ({ ...val, id, type }));
        masterData = masterData.filter(i => i.type !== type).concat(processed);
        masterData.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
        applyFilters();
    }

    function copyVal(val, btn) {
        navigator.clipboard.writeText(val);
        const original = btn.innerText;
        btn.innerText = "OK";
        setTimeout(() => btn.innerText = original, 1000);
    }

    function clearFilters() {
        document.getElementById('globalSearch').value = "";
        document.getElementById('dateFrom').value = "";
        document.getElementById('dateTo').value = "";
        document.getElementById('typeFilter').value = "all";
        applyFilters();
    }

    function applyFilters() {
        const search = document.getElementById('globalSearch').value.toLowerCase();
        const from = document.getElementById('dateFrom').value;
        const to = document.getElementById('dateTo').value;
        const type = document.getElementById('typeFilter').value;
        const body = document.getElementById('gridBody');
        
        body.innerHTML = "";
        
        const filtered = masterData.filter(item => {
            const ts = item.timestamp || 0;
            const itemDate = new Date(ts).toISOString().split('T')[0];
            
            const matchSearch = JSON.stringify(item).toLowerCase().includes(search);
            const matchType = type === 'all' || item.type === type;
            const matchFrom = !from || itemDate >= from;
            const matchTo = !to || itemDate <= to;
            
            return matchSearch && matchType && matchFrom && matchTo;
        });

        document.getElementById('counter').innerText = filtered.length;

        filtered.forEach(item => {
            const isP = item.type === 'pickup';
            const client = isP ? item.name : item.delivery_name;
            const addr = isP ? item.pickup_location : item.destination;
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td class="date-cell">${new Date(item.timestamp).toLocaleDateString()}</td>
                <td><span class="type-tag" style="background:${isP ? 'var(--pickup-accent)' : 'var(--delivery-accent)'}; color:#000;">${item.type}</span></td>
                <td class="driver-cell">${(item.assigned_to || '---').toUpperCase()}</td>
                <td style="font-weight:700;">${client || 'N/A'}</td>
                <td>${addr} <button class="copy-btn" onclick="copyVal('${addr}', this)">Copy</button></td>
                <td style="color:var(--brand-gold); font-weight:700;">${item.city || 'BRANDON'}</td>
                <td><span style="color:var(--dim); font-weight:bold;">${item.po_number || ''}</span> ${item.po_number ? `<button class="copy-btn" onclick="copyVal('${item.po_number}', this)">Copy</button>` : ''}</td>
                <td>${item.package_details || ''}</td>
                <td style="font-weight:900; font-size:10px; color:${item.status === 'completed' ? 'var(--delivery-accent)' : 'var(--brand-gold)'}">${item.status.toUpperCase()}</td>
                <td class="notes-cell">${item.other_info || ''}</td>
            `;
            body.appendChild(tr);
        });
    }

    document.querySelectorAll('.filter-input').forEach(el => el.addEventListener('input', applyFilters));
</script>

</body>
</html>
