<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E&C | Executive Grid</title>
    <style>
        :root {
            --brand-gold: #cca300;
            --bg-deep: #050505;
            --table-bg: #0f0f12;
            --border: #222;
            --text: #e0e0e0;
            --dim: #777;
            --row-hover: #16161a;
            --pickup-accent: #cc5200;
            --delivery-accent: #00b32d;
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-deep);
            color: var(--text);
            margin: 0;
            overflow: hidden; /* We will use internal scrolling for the grid */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- AUTH OVERLAY --- */
        #login-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box {
            width: 350px; background: #111; padding: 40px; border-radius: 8px; 
            border: 1px solid var(--border); text-align: center;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 10px 0; background: #000; 
            border: 1px solid #333; color: #fff; border-radius: 4px;
        }
        .login-submit {
            width: 100%; padding: 12px; background: var(--brand-gold); border: none; 
            color: #000; font-weight: 800; cursor: pointer; border-radius: 4px; margin-top: 10px;
        }

        /* --- HEADER --- */
        header {
            padding: 10px 20px;
            background: #000;
            border-bottom: 2px solid var(--brand-gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }

        .logo-group { display: flex; align-items: center; gap: 15px; }
        .logo {
            height: 40px;
            filter: drop-shadow(0 0 5px rgba(204, 163, 0, 0.3));
            animation: ultraSlowShine 10s infinite ease-in-out;
        }
        @keyframes ultraSlowShine {
            0%, 100% { filter: drop-shadow(0 0 2px var(--brand-gold)); opacity: 0.8; }
            50% { filter: drop-shadow(0 0 12px var(--brand-gold)); opacity: 1; }
        }
        .brand-title { font-weight: 900; letter-spacing: 2px; text-transform: uppercase; color: #fff; font-size: 1.1rem; }

        /* --- CONTROL BAR --- */
        .controls {
            padding: 15px 20px;
            background: #0a0a0c;
            display: flex;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .filter-input {
            background: #111; border: 1px solid #333; color: #fff;
            padding: 8px 12px; border-radius: 4px; font-size: 0.9rem;
        }
        .filter-input:focus { border-color: var(--brand-gold); outline: none; }

        .range-btn {
            background: #111; border: 1px solid #333; color: var(--dim);
            padding: 8px 12px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; cursor: pointer;
            transition: 0.2s;
        }
        .range-btn:hover, .range-btn.active { border-color: var(--brand-gold); color: #fff; background: #222; }

        .print-btn {
            background: #222; border: 1px solid var(--brand-gold); color: var(--brand-gold);
            padding: 8px 15px; border-radius: 4px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.8rem;
        }
        .print-btn:hover { background: var(--brand-gold); color: #000; }

        /* --- DATA GRID --- */
        .grid-container {
            flex: 1;
            overflow: auto;
            background: var(--bg-deep);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 1200px;
        }

        thead {
            position: sticky;
            top: 0;
            background: #1a1a1d;
            z-index: 10;
        }

        th {
            text-align: left;
            padding: 12px 15px;
            color: var(--dim);
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--brand-gold);
            white-space: nowrap;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tbody tr.summary-row { cursor: pointer; transition: 0.2s; }
        tbody tr.summary-row:hover { background: var(--row-hover); }

        .details-row { display: none; background: #0a0a0c; }
        .details-row.open { display: table-row; }
        .details-content { padding: 20px; display: flex; gap: 40px; flex-wrap: wrap; border-bottom: 2px solid #222; }
        
        .detail-group { display: flex; flex-direction: column; gap: 5px; }
        .detail-label { font-size: 10px; color: var(--dim); font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
        .detail-value { font-size: 14px; color: #fff; }

        .copy-icon {
            cursor: pointer; color: var(--brand-gold); margin-right: 8px; font-size: 12px;
        }
        .copy-btn-lg {
            background: #222; border: 1px solid #444; color: var(--text); padding: 5px 10px;
            border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 5px;
        }
        .copy-btn-lg:hover { border-color: var(--brand-gold); color: var(--brand-gold); }

        .type-tag {
            padding: 3px 8px; border-radius: 3px; font-weight: 900; font-size: 10px;
        }
        .date-cell { white-space: nowrap; font-family: monospace; color: var(--dim); }
        .driver-cell { font-weight: 800; color: var(--brand-gold); }

        /* --- VISIBILITY TOGGLES --- */
        .col-toggle-group { display: flex; gap: 15px; width: 100%; margin-top: 10px; }
        .col-checkbox { display: flex; align-items: center; gap: 3px; font-size: 14px; color: var(--dim); font-weight: 700; cursor: pointer; }
        .col-checkbox input { accent-color: var(--brand-gold); cursor: pointer; }
        .hide-col { display: none !important; }

        /* --- PRINT STYLES --- */
        @media print {
            body { height: auto; overflow: visible; background: #fff; color: #000; }
            .grid-container { overflow: visible; height: auto; }
            .controls, header, #login-overlay, .copy-icon, .copy-btn-lg, #mobile-blocker { display: none !important; }
            
            table { width: 100%; border-collapse: collapse; min-width: 0; font-size: 10px; }
            th { background: #fff; color: #000; border-bottom: 2px solid #000; position: static; }
            td { color: #000; border-bottom: 1px solid #ccc; }
            
            /* Force all details to show */
            .details-row { display: table-row !important; }
            .details-content { display: flex !important; gap: 20px; border-bottom: 1px solid #000; padding: 10px; }
            .detail-label { color: #444; }
            .detail-value { color: #000; font-weight: 600; }
            
            /* Force all columns to be visible when printing regardless of checkbox state */
            .hide-col { display: table-cell !important; }
            
            /* Adjust badges */
            .type-tag { border: 1px solid #000; }
        }

        /* --- MOBILE CARD VIEW --- */
        @media (max-width: 768px) {
            body { height: auto; overflow-y: auto; }
            .grid-container { overflow: visible; height: auto; padding-bottom: 40px; }

            /* Hide Desktop Elements: Table Header, Print/Export Buttons, Column Toggles */
            thead, .print-btn, .col-toggle-group, .copy-icon, #columnToggles { display: none !important; }

            /* Header Adjustments */
            header { flex-direction: column; height: auto; gap: 15px; align-items: flex-start; padding: 15px; }
            .logo-group { width: 100%; justify-content: space-between; }
            #live-stat { width: 100%; text-align: left; margin-top: 5px; font-size: 12px; }

            /* Control Bar Adjustments */
            .controls { height: auto; flex-direction: column; align-items: stretch; gap: 12px; padding: 15px; }
            .controls > div { width: 100%; }
            .filter-input, select.filter-input { width: 100% !important; font-size: 16px; padding: 12px; } /* 16px prevents iOS zoom */
            
            /* Scrollable Range Buttons */
            .controls > div:nth-child(4) > div {
                overflow-x: auto;
                padding-bottom: 8px;
                display: flex;
                gap: 8px;
            }
            .range-btn { flex-shrink: 0; padding: 10px 16px; font-size: 14px; }
            
            /* Full Width Reset Button */
            button[onclick="clearFilters()"] { width: 100%; padding: 12px; margin-top: 5px; background: #222; border: 1px solid #444; }

            /* Card Layout */
            table { display: block; width: 100%; min-width: 0; }
            tbody { display: block; width: 100%; }

            tr.summary-row {
                display: flex;
                flex-direction: column;
                background: #111;
                border: 1px solid var(--border);
                margin: 0 15px 15px 15px; /* Spacing between cards */
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            }

            td {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                text-align: right;
                border-bottom: 1px solid #222;
                padding: 12px 15px;
                font-size: 16px; /* Min 16px legibility */
                height: auto;
            }
            td:last-child { border-bottom: none; }
            
            /* Force visibility of all data columns regardless of desktop toggle state */
            .hide-col { display: flex !important; }

            /* Labels via CSS generated content */
            .col-0::before { content: "Date"; }
            .col-1::before { content: "Type"; }
            .col-2::before { content: "Driver"; }
            .col-3::before { content: "Pickup Contact"; }
            .col-4::before { content: "Pickup Address"; }
            .col-5::before { content: "Delivery Contact"; }
            .col-6::before { content: "Delivery Address"; }
            .col-7::before { content: "City"; }
            .col-8::before { content: "Packages"; }

            td::before {
                color: var(--dim);
                font-weight: 800;
                font-size: 11px;
                text-transform: uppercase;
                margin-right: 15px;
                min-width: 80px;
                text-align: left;
                padding-top: 4px;
            }

            /* Details Panel Expansion */
            .details-row { display: none; }
            .details-row.open { display: block; }
            
            .details-row td {
                display: block;
                padding: 0;
                border: none;
            }

            .details-content {
                display: flex;
                flex-direction: column;
                gap: 20px;
                padding: 20px;
                background: #0e0e10;
                margin: -16px 15px 25px 15px; /* Pull up to attach to card, push down next card */
                border-radius: 0 0 8px 8px;
                border: 1px solid var(--border);
                border-top: 1px solid #333;
            }
            
            .detail-value { font-size: 16px; line-height: 1.4; word-break: break-word; }
            .copy-btn-lg { padding: 12px; width: 100%; font-size: 14px; margin-top: 10px; }
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color: var(--brand-gold); margin-bottom: 20px;">EXECUTIVE GRID</h2>
        <input type="email" id="login-user" class="login-input" placeholder="Admin Email" autofocus>
        <input type="password" id="login-pin" class="login-input" placeholder="Password">
        <button class="login-submit" onclick="attemptLogin()">Authorize</button>
    </div>
</div>

<header>
    <div class="logo-group">
        <img src="icon-512.png" class="logo" alt="Logo">
        <span class="brand-title">E&C | Executive Data Hub</span>
    </div>
    
    <button onclick="manualBackup()" class="print-btn" style="position: absolute; left: 50%; transform: translateX(-50%);">BACK UP NOW</button>

    <div id="live-stat" style="font-size: 0.8rem; font-weight: 800; color: var(--dim); text-align: right;">
        <div id="backup-stat" style="color: #00ff00; font-size: 16px; margin-bottom: 3px;">Last Backup: N/A</div>
        <span id="counter" style="color: var(--brand-gold);">0</span> ENTRIES FOUND
    </div>
</header>

<div class="controls">
    <div style="display:flex; flex-direction:column; gap:4px;">
        <label style="font-size: 10px; font-weight: 800; color: var(--dim);">GLOBAL SEARCH</label>
        <input type="text" id="globalSearch" class="filter-input" style="width: 250px;" placeholder="Filter everything...">
    </div>
    
    <div style="display:flex; flex-direction:column; gap:4px;">
        <label style="font-size: 10px; font-weight: 800; color: var(--dim);">DATE FROM</label>
        <input type="date" id="dateFrom" class="filter-input">
    </div>

    <div style="display:flex; flex-direction:column; gap:4px;">
        <label style="font-size: 10px; font-weight: 800; color: var(--dim);">DATE TO</label>
        <input type="date" id="dateTo" class="filter-input">
    </div>

    <div style="display:flex; flex-direction:column; gap:4px;">
        <label style="font-size: 10px; font-weight: 800; color: var(--dim);">TYPE</label>
        <div style="display:flex; gap: 5px; align-items: center;">
            <select id="typeFilter" class="filter-input">
                <option value="all">ALL SERVICES</option>
                <option value="pickup">PICKUPS</option>
                <option value="delivery">DELIVERIES</option>
            </select>
            <button class="range-btn" onclick="updateRange(7)">Last 7 Days</button>
            <button class="range-btn" onclick="updateRange(14)">Last 14 Days</button>
            <button class="range-btn" onclick="updateRange(30)">Last 30 Days</button>
            <button class="range-btn" onclick="updateRange(90)">Last 3 Months</button>
            <button class="range-btn" onclick="updateRange(180)">Last 6 Months</button>
            <button class="range-btn" onclick="updateRange('all')">All Time</button>
        </div>
    </div>

    <button onclick="clearFilters()" style="margin-top: 18px; background: transparent; border: 1px solid #444; color: #fff; padding: 7px 15px; cursor: pointer; border-radius: 4px; font-size: 12px;">RESET</button>
    
    <div style="margin-left: auto; display: flex; gap: 10px;">
        <button onclick="exportCurrentView()" class="print-btn" style="border-color: #555; color: #fff;">EXPORT TXT</button>
        <button onclick="printAndDownload()" class="print-btn">PRINT PAGE</button>
    </div>
    <div id="columnToggles" class="col-toggle-group"></div>
</div>

<div class="grid-container">
    <table id="dataTable">
        <thead>
            <tr>
                <th class="col-0">Date</th>
                <th class="col-1">Type</th>
                <th class="col-2">Driver</th>
                <th class="col-3">Pickup Contact</th>
                <th class="col-4">Pickup Address</th>
                <th class="col-5">Delivery Contact</th>
                <th class="col-6">Delivery Address</th>
                <th class="col-7">City</th>
                <th class="col-8">Packages</th>
            </tr>
        </thead>
        <tbody id="gridBody">
            </tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    firebase.initializeApp({
        apiKey: "AIzaSyAKmgoXA4m3cRTmxJq4aUyva5SVvFbTNqg",
        authDomain: "eandccourier-36fcc.firebaseapp.com",
        databaseURL: "https://eandccourier-36fcc-default-rtdb.firebaseio.com",
        projectId: "eandccourier-36fcc"
    });

    const db = firebase.database();
    let masterData = [];
    let filteredData = []; // Store currently visible data
    let currentRange = 7; // Default 7 days
    const listeners = { pickups: null, dropoffs: null };

    // Column Config
    const columnConfig = [
        "Date", "Type", "Driver", "Pickup Contact", "Pickup Address", "Delivery Contact", "Delivery Address", "City", "Packages"
    ];
    let visibleCols = new Array(9).fill(true);

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", () => {
        renderColumnToggles();
    });

    function renderColumnToggles() {
        const container = document.getElementById('columnToggles');
        container.innerHTML = "";
        columnConfig.forEach((col, idx) => {
            const label = document.createElement('label');
            label.className = "col-checkbox";
            label.innerHTML = `<input type="checkbox" checked onchange="toggleColumn(${idx}, this.checked)"> ${col.toUpperCase()}`;
            container.appendChild(label);
        });
    }

    function toggleColumn(idx, isVisible) {
        visibleCols[idx] = isVisible;
        const styleId = `style-col-${idx}`;
        let styleTag = document.getElementById(styleId);
        
        if (!styleTag) {
            styleTag = document.createElement('style');
            styleTag.id = styleId;
            document.head.appendChild(styleTag);
        }

        // Toggle visibility using CSS class injection
        if (!isVisible) {
            styleTag.innerHTML = `.col-${idx} { display: none; }`;
        } else {
            styleTag.innerHTML = "";
        }
    }

    // --- ACCESS CONTROL ---
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            const admins = ["celeste@ec.com", "desirae@ec.com"];
            if (admins.includes(user.email.toLowerCase())) {
                document.getElementById('login-overlay').style.display = 'none';
                initSync(7); // Default 7 days
                checkAutoBackup();
            } else {
                alert("Restricted Access.");
                firebase.auth().signOut();
            }
        }
    });

    function attemptLogin() {
        const email = document.getElementById('login-user').value.trim();
        const pin = document.getElementById('login-pin').value.trim();
        firebase.auth().signInWithEmailAndPassword(email, pin).catch(e => alert(e.message));
    }

    // --- DATA FLOW ---
    function updateRange(days) {
        currentRange = days;
        initSync(days);
    }

    function initSync(days) {
        // Detach old listeners if they exist
        if (listeners.pickups) db.ref('pickups').off('value', listeners.pickups);
        if (listeners.dropoffs) db.ref('dropoffs').off('value', listeners.dropoffs);

        masterData = []; // Clear current data
        document.getElementById('gridBody').innerHTML = ""; 

        let queryPickups = db.ref('pickups').orderByChild('timestamp');
        let queryDropoffs = db.ref('dropoffs').orderByChild('timestamp');

        if (days !== 'all') {
            const ms = days * 24 * 60 * 60 * 1000;
            const startTime = Date.now() - ms;
            queryPickups = queryPickups.startAt(startTime);
            queryDropoffs = queryDropoffs.startAt(startTime);
        }

        listeners.pickups = queryPickups.on('value', s => stream('pickup', s.val()));
        listeners.dropoffs = queryDropoffs.on('value', s => stream('delivery', s.val()));
    }

    function stream(type, data) {
        // Filter out existing of same type to prevent dupes during re-sync
        masterData = masterData.filter(i => i.type !== type);
        
        const processed = Object.entries(data || {}).map(([id, val]) => ({ ...val, id, type }));
        masterData = masterData.concat(processed);
        masterData.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
        applyFilters();
    }

    // --- BACKUP & EXPORT SYSTEM ---
    
    function generateFileContent(dataArray, title) {
        if (dataArray.length === 0) return "No Data Found.";
        let textContent = `${title}\nDate Generated: ${new Date().toLocaleString()}\nEntries: ${dataArray.length}\n----------------------------------------\n\n`;
        
        dataArray.forEach(item => {
            textContent += `ID: ${item.id}\nDate: ${new Date(item.timestamp).toLocaleString()}\nType: ${item.type.toUpperCase()}\nDriver: ${item.assigned_to}\nPickup: ${item.name || 'N/A'}\nDelivery: ${item.delivery_name || 'N/A'}\nAddr: ${item.pickup_location || item.destination}\nCity: ${item.city}\nPO: ${item.po_number}\nStatus: ${item.status}\nDetails: ${item.package_details}\nNotes: ${item.other_info}\nUser: ${item.created_by || '?'} / ${item.last_edit_by || '?'}\n\n----------------------------------------\n\n`;
        });
        return textContent;
    }

    function downloadTextFile(filename, content) {
        const blob = new Blob([content], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
    }

    function getBackupFilename(startMs, endMs) {
        const months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
        const s = new Date(startMs);
        const e = new Date(endMs);
        return `backup_${months[s.getMonth()]}${s.getDate()}_${months[e.getMonth()]}${e.getDate()}.txt`;
    }

    function checkAutoBackup() {
        const lastBackup = localStorage.getItem('ec_last_backup');
        const now = new Date();
        const isFriday = now.getDay() === 5; // 5 is Friday
        
        if (lastBackup) {
            document.getElementById('backup-stat').innerText = "Last Backup: " + new Date(lastBackup).toDateString();
        }

        const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
        const timeSince = lastBackup ? now - new Date(lastBackup) : Infinity;

        if (isFriday && timeSince > (sevenDaysMs - 86400000)) { 
            backupLast7Days(true);
        }
    }

    function backupLast7Days(isAuto = false) {
        const now = Date.now();
        const sevenDaysAgo = now - (7 * 24 * 60 * 60 * 1000);
        
        // We need to fetch/filter from masterData based on strict timestamp
        const backupData = masterData.filter(item => {
            return item.timestamp >= sevenDaysAgo && item.timestamp <= now;
        });

        const filename = getBackupFilename(sevenDaysAgo, now);
        const content = generateFileContent(backupData, "E&C EXECUTIVE DATA BACKUP (7 DAYS)");
        
        downloadTextFile(filename, content);

        if (isAuto) {
            localStorage.setItem('ec_last_backup', new Date().toISOString());
            document.getElementById('backup-stat').innerText = "Last Backup: " + new Date().toDateString();
        }
    }

    function manualBackup() {
        backupLast7Days(false);
    }

    function exportCurrentView() {
        const content = generateFileContent(filteredData, "E&C EXPORT - CURRENT VIEW");
        downloadTextFile(`EC_Export_${new Date().toISOString().split('T')[0]}.txt`, content);
    }

    function printAndDownload() {
        window.print();
        // Removed downloadData() call
    }

    // --- UI HELPERS ---
    function copyLine(btn, dataStr) {
        navigator.clipboard.writeText(dataStr).then(() => {
            const span = document.createElement('span');
            span.innerText = " Copied!";
            span.style.color = "var(--brand-gold)";
            span.style.fontSize = "10px";
            span.style.fontWeight = "bold";
            btn.parentNode.insertBefore(span, btn.nextSibling);
            setTimeout(() => span.remove(), 1500);
        });
        event.stopPropagation();
    }

    function copyCardAll(btn, itemStr) {
        const item = JSON.parse(decodeURIComponent(itemStr));
        const text = `Date: ${new Date(item.timestamp).toLocaleString()}\nType: ${item.type}\nDriver: ${item.assigned_to}\nPickup: ${item.name}\nDelivery: ${item.delivery_name}\nAddress: ${item.pickup_location || item.destination}\nCity: ${item.city}\nPO: ${item.po_number}\nStatus: ${item.status}\nDetails: ${item.package_details}\nNotes: ${item.other_info}`;
        
        navigator.clipboard.writeText(text).then(() => {
            const original = btn.innerText;
            btn.innerText = "COPIED TO CLIPBOARD";
            setTimeout(() => btn.innerText = original, 1500);
        });
    }

    function toggleDetails(rowId) {
        const detailRow = document.getElementById('detail-' + rowId);
        if (detailRow.style.display === 'table-row' || detailRow.style.display === 'block') {
            detailRow.style.display = 'none';
        } else {
            // Check if mobile via matchMedia, otherwise standard table-row
            if (window.matchMedia("(max-width: 768px)").matches) {
                detailRow.style.display = 'block';
            } else {
                detailRow.style.display = 'table-row';
            }
        }
    }

    function clearFilters() {
        document.getElementById('globalSearch').value = "";
        document.getElementById('dateFrom').value = "";
        document.getElementById('dateTo').value = "";
        document.getElementById('typeFilter').value = "all";
        applyFilters();
    }

    function applyFilters() {
        const search = document.getElementById('globalSearch').value.toLowerCase();
        const from = document.getElementById('dateFrom').value;
        const to = document.getElementById('dateTo').value;
        const type = document.getElementById('typeFilter').value;
        const body = document.getElementById('gridBody');
        
        body.innerHTML = "";
        
        filteredData = masterData.filter(item => {
            const ts = item.timestamp || 0;
            const itemDate = new Date(ts).toISOString().split('T')[0];
            
            const matchSearch = JSON.stringify(item).toLowerCase().includes(search);
            const matchType = type === 'all' || item.type === type;
            const matchFrom = !from || itemDate >= from;
            const matchTo = !to || itemDate <= to;
            
            return matchSearch && matchType && matchFrom && matchTo;
        });

        document.getElementById('counter').innerText = filteredData.length;

        filteredData.forEach(item => {
            const isP = item.type === 'pickup';
            const pickupName = item.name || 'N/A';
            const delivName = item.delivery_name || 'N/A';
            const mainAddr = isP ? item.pickup_location : item.destination; // Display relevant address
            
            // Data string for line copy
            const lineData = `${new Date(item.timestamp).toLocaleDateString()} | ${item.type} | ${item.assigned_to} | ${pickupName} | ${delivName} | ${mainAddr} | ${item.city} | ${item.package_details}`;

            const tr = document.createElement('tr');
            tr.className = "summary-row";
            tr.onclick = () => toggleDetails(item.id);
            
            // Added classes col-0 to col-7 for column toggling
            tr.innerHTML = `
                <td class="col-0 date-cell">${new Date(item.timestamp).toLocaleDateString()}</td>
                <td class="col-1"><span class="type-tag" style="background:${isP ? 'var(--pickup-accent)' : 'var(--delivery-accent)'}; color:#000;">${item.type}</span></td>
                <td class="col-2 driver-cell">${(item.assigned_to || '---').toUpperCase()}</td>
                <td class="col-3" style="font-weight:700;">${pickupName}</td>
                <td class="col-4">${item.pickup_location || ''}</td>
                <td class="col-5" style="font-weight:700;">${delivName}</td>
                <td class="col-6">${item.destination || ''}</td>
                <td class="col-7" style="color:var(--brand-gold); font-weight:700;">${item.city || 'BRANDON'}</td>
                <td class="col-8">${item.package_details || ''}</td>
            `;
            
            const detailTr = document.createElement('tr');
            detailTr.id = 'detail-' + item.id;
            detailTr.className = 'details-row';
            detailTr.innerHTML = `
                <td colspan="9">
                    <div class="details-content">
                        <div class="detail-group">
                            <span class="detail-label">PO / REFERENCE</span>
                            <span class="detail-value" style="color:var(--brand-gold);">${item.po_number || 'N/A'}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">STATUS</span>
                            <span class="detail-value" style="font-weight:900; color:${item.status === 'completed' ? 'var(--delivery-accent)' : 'var(--pickup-accent)'}">${(item.status || 'pending').toUpperCase()}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">DRIVER NOTES (OTHER INFO)</span>
                            <span class="detail-value" style="font-style:italic; color:#aaa;">${item.other_info || 'None'}</span>
                        </div>
                         <div class="detail-group">
                            <span class="detail-label">CREATED BY</span>
                            <span class="detail-value">${item.created_by || 'Unknown'}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">LAST EDIT BY</span>
                            <span class="detail-value">${item.last_edit_by || 'Unknown'}</span>
                        </div>
                        <div class="detail-group" style="margin-left:auto;">
                            <button class="copy-btn-lg" onclick="copyCardAll(this, '${encodeURIComponent(JSON.stringify(item))}')">COPY CARD INFO</button>
                        </div>
                    </div>
                </td>
            `;

            body.appendChild(tr);
            body.appendChild(detailTr);
        });
    }

    document.querySelectorAll('.filter-input').forEach(el => el.addEventListener('input', applyFilters));
</script>

</body>
</html>
